<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cirrus-ui/dist/cirrus.min.css" />
  <title>car management</title>
  <style>
    /* 使得h1标题居中 */
    h1 {
      text-align: center;
    }

    /* 使用Flexbox来居中并排列按钮 */
    .button-container {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      max-width: 400px;
      /* 考虑到按钮和间距的大小，增大最大宽度 */
      margin: 0 auto;
    }

    #userInfo {
      position: absolute;
      right: 20px;
      top: 20px;
    }

    .exit {
      display: flex;
      flex-wrap: wrap;
      margin-left: 850px;
    }
  </style>
</head>

<body>

  <div align="center">
    <image src="./static/sysu_faviox.jpg" width="350" height="150" position: relative>
      <div class="divider"></div>
  </div>
  <div class="u-flex u-justify-space-between u-gap-2 u-items-center">
    <div class="u-flex u-flex-row u-gap-2 u-items-center">
      <image src="./static/sysu.jpg" width="1600" height="1000" position: relative>
    </div>
    <!--右半区-->
    <div class="frame" style="height: 45rem; width: 60rem;">
      <div align="center">
        <div class="frame__header">
          <h1 id="welcomeMessage"> 个中心 </h1>
          <div class="avatar--xl"><img src="https://i.imgur.com/sbKJVxr.png" /></div>
          <!--数据库拿用户名-->
          <p class="u-text-center frame__title">John Doe</p>
          <p class="u-text-center frame__subtitle">Former youngest person on Earth</p>
          <button type="button" class="btn-success btn--xl" onclick="storeCar()">我要存车</button>
          <button type="button" class="btn-success btn--xl" onclick="takeOutCar()">我要取车</button>
          <!--更改显示个人信息-->
          <br /><button type="button" class="btn-success btn--xl" onclick="takeOutCar()">修改个人信息</button>
          <br /><button type="button" class="btn-success btn--md" onclick="ReturnPage()">退出登录</button>
          <div id="userInfo"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="divider"></div>
  </div>

  <script>
    var userInfo = null;
    function takeOutCar () {
      // 获取licensePlate
      var confirmed = confirm("Confirm to take out " + userInfo.licensePlate + "?");
      if (!confirmed) {
        return;
      }

      // 创建XMLHttpRequest对象
      var xhttp = new XMLHttpRequest();

      // 设置请求方法和URL
      xhttp.open("POST", "/parking/frontend/takeOutCar", true);

      // 设置请求头
      xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

      // 发送数据
      xhttp.send("licensePlate=" + userInfo.licensePlate);

      // 处理服务器响应
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          var response = JSON.parse(this.responseText);
          alert(response.message + "\nFee: " + response.cost); // 在提示中显示费用
        }
      };
    }

    function ReturnPage () {
      window.location.href = "index.html"
    }


    function storeCar () {
      // 获取licensePlate和entryTime
      var confirmed = confirm("Confirm to store " + userInfo.licensePlate + "?");
      if (!confirmed) {
        return;
      }

      // 创建XMLHttpRequest对象
      var xhttp = new XMLHttpRequest();

      // 设置请求方法和URL
      xhttp.open("POST", "/parking/frontend/storeCar", true);

      // 设置请求头
      xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

      // 发送数据
      xhttp.send("licensePlate=" + userInfo.licensePlate);

      // 处理服务器响应
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          alert("Store Car Operation Successful!"); // 新增的代码
        }
      };
    }
    // 解析URL以获取username
    var urlParams = new URLSearchParams(window.location.search);
    var username = urlParams.get('username');

    // 向服务器发送Ajax请求以获取用户信息
    var xhttp = new XMLHttpRequest();
    xhttp.open("GET", "/parking/frontend/getUserInfo?username=" + username, true);
    xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xhttp.send();

    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        userInfo = JSON.parse(this.responseText);
        // 显示用户名和车牌号
        document.getElementById("userInfo").innerText = "Username: " + userInfo.username + ", LicensePlate: " + userInfo.licensePlate;
        // 修改欢迎语为"Welcome, <username>"
        document.getElementById("welcomeMessage").innerText = "Welcome, " + userInfo.username;
      }
    };

  </script>
</body>

</html>